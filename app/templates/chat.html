<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì…ì‹œë„ìš°ë¯¸ ìˆ˜ë£¡ì´</title>
    <link rel="stylesheet" href="/static/assets/style_chat.css" />
  </head>
  <body class="chat-body-bg">
    <!-- ìƒë‹¨ ë°” -->
    <div class="chat-header">
      <div class="logo-group">
        <img src="/static/assets/logo.png" alt="ì„±ì‹ ì—¬ëŒ€ ë¡œê³ " class="logo-img" />
      </div>
      <div class="header-buttons">
        <div class="header-icon"></div>
      </div>
      <!-- ë©”ì¸ìœ¼ë¡œ ë²„íŠ¼ ì¶”ê°€ -->
      <button class="go-home-btn" onclick="goToMain()" title="ë©”ì¸ìœ¼ë¡œ"></button>
    </div>

    <!-- ì±„íŒ… ë‚´ìš© -->
    <div class="chat-container" id="chatBody">
      <!-- ì±„íŒ… ë§í’ì„ ì€ JSë¡œ ì¶”ê°€ë¨ -->
    </div>

    <!-- ì…ë ¥ì°½ -->
    <div class="input-area">
      <textarea id="questionInput" placeholder="ìˆ˜ë£¡ì´ì—ê²Œ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë´!"></textarea>
      <button onclick="sendMessage()" class="send-btn">&#x2191;</button>
    </div>

    <div class="recommend-questions" id="recommendQuestions"> 
    </div>

    <script>
      async function sendMessage() {
        const input = document.getElementById("questionInput");
        const text = input.value.trim();
        if (!text) return;

        const rec = document.getElementById("recommendQuestions");
        rec.innerHTML = "";
        rec.style.display = "none";
    
        const chatBody = document.getElementById("chatBody");
    
      
        const userBubble = document.createElement("div");
        userBubble.className = "chat-bubble user";
        userBubble.textContent = text;
        chatBody.appendChild(userBubble);
        input.value = "";
        chatBody.scrollTop = chatBody.scrollHeight;
    
       
        const botContainer = document.createElement("div");
        botContainer.className = "bot-container";
    
        const suryongImg = document.createElement("img");
        suryongImg.src = "/static/assets/suryong.png";
        suryongImg.alt = "ìˆ˜ë£¡ì´";
        suryongImg.className = "suryong-profile";
    
        const botBubble = document.createElement("div");
        botBubble.className = "chat-bubble bot";
        botBubble.textContent = "ì…ë ¥ì¤‘ì…ë‹ˆë‹¤..."; 
    
        botContainer.appendChild(suryongImg);
        botContainer.appendChild(botBubble);
        chatBody.appendChild(botContainer);
        chatBody.scrollTop = chatBody.scrollHeight;
    
        try {
  const res = await fetch("/query", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query: text })
  });

  console.log("[DEBUG] /query ì‘ë‹µ ìƒíƒœ:", res.status, res.statusText);

  const rawText = await res.text(); // ë¨¼ì € ì›ë³¸ í…ìŠ¤íŠ¸ í™•ì¸
  console.log("[DEBUG] /query ì›ë³¸ ì‘ë‹µ:", rawText);

  let data;
  try {
    data = JSON.parse(rawText);
  } catch (parseError) {
    console.error("[DEBUG] JSON íŒŒì‹± ì‹¤íŒ¨:", parseError);
    throw parseError; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ catchë¡œ ë„˜ì–´ê°
  }

  botBubble.textContent = data.answer || "ë‹µë³€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.";
  chatBody.scrollTop = chatBody.scrollHeight;

} catch (error) {
  console.error("[DEBUG] fetch ì˜¤ë¥˜:", error);
  botBubble.textContent = "ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”.";
  chatBody.scrollTop = chatBody.scrollHeight;
}

      }
      const textarea = document.getElementById('questionInput');

      let typingTimer;  
const typingDelay = 400; 
const input = document.getElementById("questionInput");

input.addEventListener("input", () => {
  clearTimeout(typingTimer); 
  if (input.value.trim()) { 
    typingTimer = setTimeout(fetchSuggestions, typingDelay); 
  }
});

async function fetchSuggestions() {
  const text = input.value.trim();
  if (!text) return;

  try {
    const res = await fetch("/suggest", {
      method: "POST", 
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: text }) 
    });

    const data = await res.json();
    const results = Array.isArray(data?.results) ? data.results.slice(0, 3) : [];
    updateSuggestedTags(results);
  } catch (e) {
    console.warn("ì¶”ì²œ ì§ˆë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
    updateSuggestedTags([]);
  }
}

function updateSuggestedTags(questions) { 
  const container = document.getElementById("recommendQuestions");
  container.innerHTML = "";

  const safeList = Array.isArray(questions) ? questions : [];

  // ëª©ë¡ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê³  ì¢…ë£Œ
  if (safeList.length === 0) {
    container.style.display = "none";
    return;
  }
  // ëª©ë¡ì´ ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê¸°
  container.style.display = "flex";

  safeList.forEach(q => {
    const tag = document.createElement("div");
    tag.className = "recommend-question-tag";
    tag.textContent = `#${q}`; 
    tag.onclick = () => { 
      input.value = q; 
      input.focus();
      sendMessage(); 

      // í´ë¦­ í›„ ì¶”ì²œì˜ì—­ ìˆ¨ê¸°ê¸°
      container.innerHTML = "";
      container.style.display = "none";
    };
    container.appendChild(tag); 
  });
}


function goToMain() {
  window.location.href = "/"; 
}



textarea.addEventListener("keydown", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();      
    sendMessage();           
  }
});

window.addEventListener("DOMContentLoaded", () => {
    const chatBody = document.getElementById("chatBody");

    
    if (chatBody.children.length > 0) return;

    const botContainer = document.createElement("div");
    botContainer.className = "bot-container";

    const suryongImg = document.createElement("img");
    suryongImg.src = "/static/assets/suryong.png";
    suryongImg.alt = "ìˆ˜ë£¡ì´";
    suryongImg.className = "suryong-profile";

    const botBubble = document.createElement("div");
    botBubble.className = "chat-bubble bot";
    botBubble.textContent =
      "GPT-4.0 ê¸°ë°˜ì˜ ì„±ì‹ ì—¬ìëŒ€í•™êµ ì±—ë´‡ â€œìˆ˜ë£¡ì´â€ì…ë‹ˆë‹¤. ğŸ‰\n" +
      "ì„±ì‹ ì—¬ëŒ€ 2026í•™ë…„ë„ ìˆ˜ì‹œëª¨ì§‘ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹ ê°€ìš”? \n" +
      "ì €ëŠ” ì§ˆë¬¸ì´ êµ¬ì²´ì ì¼ìˆ˜ë¡ ë” ì •í™•í•œ ë‹µë³€ì„ ë“œë¦´ìˆ˜ ìˆì–´ìš”! ğŸ‰\n\n" +
      "ğŸ”® ë‹¨ì–´ê°€ ì•„ë‹Œ ë¬¸ì¥ í˜•íƒœë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. (ex. â€œìˆ˜ì‹œ ëª¨ì§‘ ì¼ì •ì´ ì–¸ì œì¸ê°€ìš”?â€ )\n" +
      "ğŸ”® ì €ëŠ” ì„±ì‹ ì—¬ìëŒ€í•™êµ 2026í•™ë…„ë„ ìˆ˜ì‹œëª¨ì§‘ìš”ê°•ì„ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•˜ê³  ìˆì–´ìš”.\n" +
      "ğŸ”® ì„±ì‹ í¬íƒˆ, ë„ì„œê´€, ê³µì‹ í™ˆí˜ì´ì§€, ì»¤ë®¤ë‹ˆí‹° ë“± ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì˜ ì •ë³´ëŠ” ì•Œì§€ ëª»í•´ìš”.\n"+
      "ğŸ”® ì œê°€ ì œê³µí•˜ëŠ” ì •ë³´ëŠ” í•­ìƒ ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. ì •í™•í•œ ì •ë³´ëŠ” ì•ˆë‚´ëœ ì¶œì²˜ë¥¼ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.\n" +
      "ğŸ”® ì €ëŠ” ì—¬ëŸ¬ë¶„ì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•Šì•„ìš”. ì•ˆì‹¬í•˜ê³  ì´ìš©í•´ì£¼ì„¸ìš”.\n" ;

    botContainer.appendChild(suryongImg);
    botContainer.appendChild(botBubble);
    chatBody.appendChild(botContainer);

    
    chatBody.scrollTop = chatBody.scrollHeight;
  });
    </script>    
  </body>
</html>
